const game=document.querySelector("#tetris"),gridEl=document.createElement("div"),infosEl=document.createElement("div"),nextBlockEl=document.createElement("div"),nbLinesEl=document.createElement("div");let currentBlock=null,nextBlockType=null,loopTimeout=null;function loop(){if(!tetris.checkEnd()){if(currentBlock.isFalling||(currentBlock=new tetris.Block(nextBlockType,tetris.blockStartPos),nextBlockType=randomNb(tetris.blockNbTypes),tetris.displayNextBlock(nextBlockType,nextBlockEl)),currentBlock.isNextPosValid())currentBlock.fall(),loopTimeout=setTimeout(loop,tetris.delay);else{currentBlock.register();let e=tetris.checkLines();if(e.length>0){for(let l of e){let o=game.querySelector(`tr:nth-of-type(${l+1})`),t=o.querySelectorAll(".block");t.forEach(e=>e.classList.add("explode"))}playLinesSound(e.length),wait(500).then(()=>{for(let l of e)tetris.removeRow(l),tetris.addRow(),tetris.lines+=1,tetris.lines%tetris.linesNextLvl==0&&(tetris.delay-=tetris.delayUpdate);tetris.displayGrid(),nbLinesEl.textContent=tetris.lines,loopTimeout=setTimeout(loop,tetris.delay)})}else tetris.playSoundFX("softdrop"),loopTimeout=setTimeout(loop,tetris.delay)}}}function randomNb(e){return Math.floor(Math.random()*e)}function playLinesSound(e){switch(e){case 1:tetris.playSoundFX("single");break;case 2:tetris.playSoundFX("double");break;case 3:tetris.playSoundFX("triple");break;case 4:tetris.playSoundFX("tetris");break;default:return}}function wait(e){return new Promise((l,o)=>{setTimeout(()=>l(e),e)})}function debug(e){if(tetris.debugMode){let l=`${e} - 
        PosX: ${currentBlock.pos[0]}
        Width: ${currentBlock.shapeWidth}
        Valid left: ${currentBlock.isNextPosValid("left")}
        Valid right: ${currentBlock.isNextPosValid("right")}
        Valid bottom: ${currentBlock.isNextPosValid()}`;console.log(l)}}gridEl.className="grid",infosEl.className="infos",nextBlockEl.className="next-block",nbLinesEl.id="lines",infosEl.appendChild(nextBlockEl),infosEl.appendChild(nbLinesEl),game.appendChild(gridEl),game.appendChild(infosEl),tetris.init(gridEl),currentBlock=new tetris.Block(randomNb(tetris.blockNbTypes),tetris.blockStartPos),nextBlockType=randomNb(tetris.blockNbTypes),tetris.displayNextBlock(nextBlockType,nextBlockEl),nbLinesEl.textContent=tetris.lines,loop(),document.addEventListener("keydown",function(e){let l=e.code,o=Array.from(currentBlock.pos);switch(l){case"ArrowLeft":currentBlock.isNextPosValid("left")&&(o[0]-=1,currentBlock.move(o)),debug("Left");break;case"ArrowRight":currentBlock.isNextPosValid("right")&&(o[0]+=1,currentBlock.move(o)),debug("Right");break;case"ArrowDown":currentBlock.isFalling&&(clearTimeout(loopTimeout),loop()),debug("Down");break;case"ArrowUp":case"Space":currentBlock.isFalling&&(currentBlock.rotates(),tetris.playSoundFX("move")),debug("Rotate");break;default:return}});